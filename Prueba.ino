//****************************************************ESP32 PS3 Controller pca9685--------------------- Manejo robot con el control PS3 ****************************************************//
#include <Adafruit_PWMServoDriver.h>
//******************************************************************************************************************************************************************************************//
// Incluir las bibliotecas requeridas
#include <Ps3Controller.h>
#include <Wire.h>
#include <Adafruit_PWMServoDriver.h>


Adafruit_PWMServoDriver pca9685 = Adafruit_PWMServoDriver(0x40);

#define SERVOMIN  150 // Valor mínimo
#define SERVOMAX  520  // Valor máximo
//********************************************************************************************************************************************************************************************//




//****************************************************************************Función de manejo*******************************************************************************************//
void notify() {
  //BOTONES LADO DERECHO DEL CONTROL(EQUIS, CIRCULO, TRIANGULO, CUADRADO)//
  
  // ---------------------------------Botón X----------------Condición Posición Descanso-Robot Parado-----------------------------------//
 if (Ps3.event.button_down.cross) {
    Serial.println("Botón X");

    setServo(0,0);
    setServo(1,0);
    setServo(2,0);
    setServo(3,0);
    setServo(4,0);
    setServo(5,0);
    setServo(6,0);
    setServo(7,0);
    setServo(8,0);
    setServo(9,0);
    setServo(10,0);
    setServo(11,0);
    setServo(12,0);
    setServo(13,0);
    setServo(14,0);
    setServo(15,0);
  }
}
//******************************************************************************************************************************************************************************************//




//****************************************************************************Función de conexión******************************************************************************************//
void onConnect() {
  Serial.println("Conectado...");
}
//*****************************************************************************************************************************************************************************************//




//*******************************************************************************Función Setup*******************************************************************************************//
void setup() {
  Serial.begin(115200);
 
  pca9685.begin();  // Inicializa PCA9685
  pca9685.setPWMFreq(50);   // Establece la frecuencia PWM en 50 Hz

 
  // Definir función de devolución de llamada
  Ps3.attach(notify);
  // Definir la función de conexión
  Ps3.attachOnConnect(onConnect);
// Emular la consola como una dirección MAC específica (cambiar según sea necesario)
  Ps3.begin("78:18:81:57:05:fd");

  Serial.println("Listo");
}
//*****************************************************************************************************************************************************************************************//




//**********************************************************************Función Creación de arreglo para usar la PCA9685*******************************************************************//
void setServo(uint8_t n_servo, int angulo) {
  int duty;
  duty=map(angulo,-90,90,SERVOMIN, SERVOMAX);
  pca9685.setPWM(n_servo, 0, duty);  
}
//*****************************************************************************************************************************************************************************************//




 //***************************************************************************************Función Loop***********************************************************************************//
void loop() {
  if (!Ps3.isConnected())
    return;
  delay(2000);
}
//*****************************************************************************************************************************************************************************************//
